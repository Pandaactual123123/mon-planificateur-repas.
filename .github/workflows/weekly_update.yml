name: Weekly Grocery Update
on:
  schedule:
    - cron: '0 13 * * 0' # 8:00 AM EST every Sunday
  workflow_dispatch: # Allows you to trigger it manually for testing

jobs:
  update-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch New Report from Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # We send the specific instructions to Gemini to get the "Noise Texture" HTML
          curl https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }} \
          -H 'Content-Type: application/json' \
          -d '{
            "contents": [{
              "parts":[{"text": "Generate a full HTML code (single file) for a grocery report in Quebec (G3G). 
              Template: Noise Texture. 
              Sections required: 
              1. Header with current date. 
              2. Spend Banner (~45$ budget). 
              3. Table with 10+ deals (Action: Maxi Direct, Imbattable IGA, or Imbattable Super C). 
              4. Section: ðŸ“¦ Faire des rÃ©serves (Stock-up 2-3 items). 
              5. 4 Baby-friendly recipes (Thai, Mexican, BBQ, Quebec). 
              6. List for AnyList (Sorted by store/action). 
              Return ONLY raw HTML code."}]
            }]
          }' | jq -r '.candidates[0].content.parts[0].text' > index.html

      - name: Commit and Push
        run: |
          git config --global user.name 'GroceryBot'
          git config --global user.email 'bot@grocery.io'
          git add index.html
          git commit -m "Weekly report update $(date +'%Y-%m-%d')"
          git push
