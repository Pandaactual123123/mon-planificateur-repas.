name: Weekly Grocery Update
on:
  schedule:
    - cron: '0 13 * * 0' # 8:00 AM EST every Sunday
  workflow_dispatch: # Allows you to trigger it manually for testing

jobs:
  update-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

     - name: Fetch New Report from Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Get the response and store it in a temp file
          curl -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
          -H 'Content-Type: application/json' \
          -d '{
            "contents": [{
              "parts":[{"text": "Return ONLY the raw HTML code for a grocery report based on the Noise Texture template for G3G. Do not include markdown code blocks like ```html. Start directly with <!DOCTYPE html>."}]
            }]
          }' > response.json

          # 2. Extract the text and remove any potential markdown artifacts
          cat response.json | jq -r '.candidates[0].content.parts[0].text' | sed 's/^```html//' | sed 's/```$//' > index.html

      - name: Commit and Push
        run: |
          git config --global user.name 'GroceryBot'
          git config --global user.email 'bot@grocery.io'
          git add index.html
          git commit -m "Weekly report update $(date +'%Y-%m-%d')"
          git push
