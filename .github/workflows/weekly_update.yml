name: Weekly Grocery Update
on:
  schedule:
    - cron: '0 13 * * 0' # 8:00 AM EST every Sunday
  workflow_dispatch: 

jobs:
  update-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch New Report from Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Prepare the instructions
          PROMPT="Act as a grocery strategist for a family in Quebec (G3G). Generate a single-file HTML report based on the Noise Texture template. Sections required: Header, Spend Banner (~45$ budget), Table with 10+ deals focusing on Maxi Price-Matching (Imbattables), Section: Faire des r√©serves, 4 Baby-friendly recipes, and a list for AnyList. Output ONLY raw HTML. Start directly with <!DOCTYPE html>."

          # 2. Call the API using the stable v1 endpoint and Gemini 2.0
          curl -X POST "https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}" \
          -H 'Content-Type: application/json' \
          -d "{
            \"contents\": [{
              \"parts\":[{\"text\": \"$PROMPT\"}]
            }]
          }" > response.json

          # 3. Extract and clean the code
          # This handles both standard text and text wrapped in markdown blocks
          cat response.json | jq -r '.candidates[0].content.parts[0].text' | sed 's/^```html//' | sed 's/^```//' | sed 's/```$//' > index.html

      - name: Commit and Push
        run: |
          git config --global user.name 'GroceryBot'
          git config --global user.email 'bot@grocery.io'
          git add index.html
          git diff --quiet && git diff --staged --quiet || (git commit -m "Weekly report update $(date +'%Y-%m-%d')" && git push)
